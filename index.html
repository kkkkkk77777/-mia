<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AiM Studio V21.0 | è’™å¤ªå¥‡å›å½’ç‰ˆ</title>
    <style>
        /* ================= è§†è§‰ç³»ç»Ÿ ================= */
        :root {
            --bg-deep: #050507;
            --glass-surface: #121214;
            --glass-border: #27272a;
            --primary: #00E676; /* ç»¿è‰²ï¼šä»£è¡¨é€»è¾‘é€šç•…/æ‰§è¡Œæ­£ç¡® */
            --text-main: #fff;
            --font-family: 'Inter', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-family);
            margin: 0; padding: 0;
        }

        .container { max-width: 1900px; margin: 0 auto; padding: 40px; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); padding-bottom: 20px; }
        .brand-logo { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        .status-badge { font-size: 12px; background: #1c1c1e; padding: 4px 10px; border-radius: 20px; color: #00E676; border: 1px solid #333; font-family: monospace; }

        /* ================= ğŸ­ å¡å¸å¢™ ================= */
        .cast-section {
            background: var(--glass-surface);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .char-card {
            background: #000; border: 1px solid #333; border-radius: 8px; padding: 8px;
            display: flex; flex-direction: column; gap: 8px; position: relative;
        }
        
        .img-upload-box {
            width: 100%; aspect-ratio: 1/1; background: #111; border: 1px dashed #444; border-radius: 6px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        .img-upload-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .upload-hint { font-size: 10px; color: #555; text-align: center; }
        .file-input { display: none; }
        
        .char-input {
            background: transparent; border: none; border-bottom: 1px solid #333; color: white;
            padding: 4px 0; font-size: 12px; width: 100%; outline: none;
        }
        .char-input:focus { border-color: var(--primary); }

        .add-btn {
            border: 1px dashed #444; border-radius: 8px; background: transparent; color: #666;
            cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 180px; font-size: 24px; transition: 0.2s;
        }
        .add-btn:hover { border-color: var(--primary); color: var(--primary); }
        .remove-btn { position: absolute; top: -5px; right: -5px; background: #d32f2f; width: 18px; height: 18px; border-radius: 50%; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; z-index: 10; }

        /* ================= è¾“å…¥åŒº ================= */
        .input-row { display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-bottom: 20px; }
        
        .style-input {
            width: 100%; height: 150px; background: #1A1A1D; border: 1px solid var(--primary); 
            color: #eee; padding: 15px; border-radius: 12px; outline: none; resize: none; font-family: sans-serif; box-sizing: border-box;
        }
        
        .script-input {
            width: 100%; height: 150px; background: var(--glass-surface); border: 1px solid var(--glass-border); 
            color: #fff; padding: 15px; border-radius: 12px; outline: none; resize: none; font-family: 'Menlo', monospace; box-sizing: border-box;
        }

        .action-bar { display: flex; justify-content: flex-end; gap: 15px; margin-bottom: 30px; }
        
        .btn { padding: 12px 40px; border-radius: 30px; font-weight: 700; cursor: pointer; border: none; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 15px rgba(0, 230, 118, 0.3); }
        .btn-primary:hover { background: #69F0AE; transform: translateY(-1px); }
        .btn-secondary { background: #27272a; color: #fff; border: 1px solid #333; }

        /* ================= è¡¨æ ¼ ================= */
        .table-wrap { background: #000; border-radius: 12px; border: 1px solid var(--glass-border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1800px; }
        th { text-align: left; padding: 15px; color: #666; font-size: 11px; font-weight: 700; border-bottom: 1px solid #222; background: #09090b; text-transform: uppercase; }
        td { padding: 20px; vertical-align: top; border-bottom: 1px solid #222; font-size: 13px; line-height: 1.6; color: #ccc; }
        
        .camera-col { color: #448AFF; font-weight: 700; }
        .asset-col { color: #FFD700; font-size: 12px; }
        
        .prompt-box { background: #111; padding: 12px; border-radius: 6px; font-family: monospace; color: #b9f6ca; border: 1px solid #333; font-size: 11px; white-space: pre-wrap; }
        .style-suffix { color: #FF9E80; font-weight: bold; } /* åç¼€é«˜äº® */
        
        .loading-spinner { width: 12px; height: 12px; border: 2px solid #000; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="brand-logo">AiM Studio V21</div>
            <div class="status-badge">ğŸ”’ Model: gemini-3-pro-preview | Logic: Montage Split</div>
        </header>

        <div class="cast-section">
            <div style="font-size:13px; font-weight:700; color:#aaa; margin-bottom:15px;">ğŸ­ è§’è‰²å¡å¸ (Cast Board) - AIå°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å…¥</div>
            <div class="cast-grid" id="castGrid">
                <button class="add-btn" onclick="addCharacter()">+</button>
            </div>
        </div>

        <div class="input-row">
            <div>
                <div style="font-size:13px; font-weight:700; color:#00E676; margin-bottom:10px;">â‘  å…¨å±€é£æ ¼åç¼€ (FIXED SUFFIX)</div>
                <textarea id="styleInput" class="style-input" placeholder="åœ¨æ­¤è¾“å…¥å›ºå®šçš„MJåç¼€ï¼Œä¾‹å¦‚ï¼š
cinematic lighting, dark fantasy style, 8k resolution, shot on film --ar 16:9 --v 6.0"></textarea>
            </div>
            <div>
                <div style="font-size:13px; font-weight:700; color:#aaa; margin-bottom:10px;">â‘¡ å‰§æœ¬ (Script)</div>
                <textarea id="scriptInput" class="script-input" placeholder="åœ¨æ­¤ç²˜è´´å‰§æœ¬..."></textarea>
            </div>
        </div>

        <div class="action-bar">
            <button class="btn btn-secondary" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡ºè¡¨æ ¼</button>
            <button class="btn btn-primary" id="generateBtn" onclick="runAI()">
                <div class="loading-spinner" id="loadingIcon"></div>
                <span id="btnText">ğŸš€ è’™å¤ªå¥‡æ‹†è§£ & ç”Ÿæˆ</span>
            </button>
        </div>

        <div class="table-wrap">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th width="60">#</th>
                        <th width="150">é•œå¤´è¯­è¨€ (Camera)</th>
                        <th width="20%">èµ„äº§è°ƒç”¨ (Assets)</th>
                        <th width="30%">ç”»é¢æè¿° (Visual - Split Action)</th>
                        <th>MJ æç¤ºè¯ (Base + Suffix)</th>
                        <th width="80">æ—¶é•¿</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align: center; padding: 60px; color: #444;">è¯·å¡«å†™å·¦ä¾§åç¼€ + å³ä¾§å‰§æœ¬ï¼Œç‚¹å‡»ç”Ÿæˆä½“éªŒâ€œä¸‰åˆ€å‰ªè¾‘â€ã€‚</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ================= ğŸ”’ æ ¸å¿ƒé…ç½® (ä½ è¦çš„éƒ½åœ¨è¿™) =================
        const API_KEY = "AIzaSyAn-evgXcie3NqVymKOXudU3pohAmYeF_w"; 
        const MODEL_NAME = "gemini-3-pro-preview"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

        // ================= ğŸ­ è§’è‰²ç®¡ç† =================
        let charCount = 0;
        window.onload = function() { addCharacter(); };

        function addCharacter() {
            if (charCount >= 10) return;
            charCount++;
            const grid = document.getElementById('castGrid');
            const btn = document.querySelector('.add-btn');
            const div = document.createElement('div');
            div.className = 'char-card';
            div.innerHTML = `
                <button class="remove-btn" onclick="this.parentElement.remove(); charCount--;">Ã—</button>
                <div class="img-upload-box" onclick="this.nextElementSibling.click()">
                    <img src="" class="preview">
                    <span class="upload-hint">ç‚¹å‡»ä¸Šä¼ </span>
                </div>
                <input type="file" class="file-input" accept="image/*" onchange="previewImg(this)">
                <input type="text" class="char-input char-name" placeholder="è§’è‰²å">
                <input type="text" class="char-input char-desc" placeholder="å¤–è²Œç‰¹å¾">
            `;
            grid.insertBefore(div, btn);
        }

        function previewImg(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = input.previousElementSibling.querySelector('img');
                    const hint = input.previousElementSibling.querySelector('span');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    hint.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function getCastInfo() {
            let info = [];
            document.querySelectorAll('.char-card').forEach(card => {
                const name = card.querySelector('.char-name').value.trim();
                const desc = card.querySelector('.char-desc').value.trim();
                if(name) info.push(`${name}: ${desc}`);
            });
            return info.join("; ");
        }

        // ================= ğŸ§  AI æ ¸å¿ƒé€»è¾‘ (è’™å¤ªå¥‡ä¿®å¤ç‰ˆ) =================
        async function runAI() {
            const script = document.getElementById('scriptInput').value.trim();
            const styleSuffix = document.getElementById('styleInput').value.trim(); 
            const castInfo = getCastInfo();

            if (!styleSuffix) { alert("è¯·åœ¨å·¦ä¾§å¡«å†™ã€å…¨å±€é£æ ¼åç¼€ã€‘ï¼"); return; }
            if (!script) { alert("è¯·åœ¨å³ä¾§å¡«å†™ã€å‰§æœ¬ã€‘ï¼"); return; }

            const btn = document.getElementById('generateBtn');
            const icon = document.getElementById('loadingIcon');
            const txt = document.getElementById('btnText');
            const tbody = document.getElementById('tableBody');
            
            btn.disabled = true;
            icon.style.display = "inline-block";
            txt.innerText = "AI å¯¼æ¼”æ€è€ƒä¸­...";
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:60px; color:#aaa;">æ­£åœ¨è¿æ¥ Google...<br>æ­£åœ¨æ‰§è¡Œï¼šè’™å¤ªå¥‡æ‹†è§£ç­–ç•¥ (Split Actions)</td></tr>`;

            // ğŸ”¥ V21 æ ¸å¿ƒ Promptï¼šæ‰¾å›äº†â€œè’™å¤ªå¥‡â€æŒ‡ä»¤ï¼Œå¹¶ç»“åˆäº†â€œå‘¨èŠ·è‹¥â€æ¡ˆä¾‹æ•™å­¦ ğŸ”¥
            const systemPrompt = `
                ä½ æ˜¯ä¸€ä½ä¸–ç•Œé¡¶çº§çš„ç”µå½±åˆ†é•œå¯¼æ¼”ã€‚ä½ çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯ã€è’™å¤ªå¥‡æ€ç»´ (Montage Thinking)ã€‘ã€‚
                ä½ å¾—åˆ°çš„ä»»åŠ¡æ˜¯å°†ä¸€æ®µæ–‡å­—å‰§æœ¬ï¼Œæ‹†è§£ä¸ºä¸€ç»„å…·æœ‰é•œå¤´æ„Ÿçš„æ‹æ‘„åˆ—è¡¨ã€‚

                ã€è§’è‰²åº“ (Cast)ã€‘: ${castInfo}

                ã€æ ¸å¿ƒæ³•åˆ™ï¼šå¿…é¡»ä¸¥æ ¼æ‰§è¡Œã€‘
                1. **ä¸¥ç¦æµæ°´è´¦**ï¼šç»å¯¹ä¸è¦æŠŠâ€œä»–èµ°äº†è¿‡æ¥ï¼Œæ‹¿èµ·æ¯å­ï¼Œå–äº†ä¸€å£â€å†™åœ¨åŒä¸€è¡Œã€‚è¿™å¿…é¡»æ˜¯ä¸‰ä¸ªé•œå¤´ï¼
                2. **è§†è§‰ä½ç§»æ£€æµ‹**ï¼š
                   - çœ‹åˆ°ç¯å¢ƒæè¿° -> æ‹†è§£ä¸ºã€å…¨æ™¯/LSã€‘ã€‚
                   - çœ‹åˆ°å…·ä½“åŠ¨ä½œ -> æ‹†è§£ä¸ºã€ä¸­æ™¯/MSã€‘ã€‚
                   - çœ‹åˆ°ç‰©å“äº¤äº’ -> æ‹†è§£ä¸ºã€ç‰¹å†™/CUã€‘ã€‚
                   - çœ‹åˆ°çœ¼ç¥/å¾®è¡¨æƒ… -> æ‹†è§£ä¸ºã€å¤§ç‰¹å†™/ECUã€‘ã€‚
                
                ã€ç¤ºä¾‹æ•™å­¦ã€‘ï¼š
                è¾“å…¥ï¼š"å¤§æ®¿ç‹¼è—‰ã€‚å‘¨èŠ·è‹¥æ‘˜ä¸‹å‡¤å† æ‰”åœ¨åœ°ä¸Šï¼Œçœ¼ç¥å‡„ç¾ã€‚"
                è¾“å‡º JSON æ•°ç»„ï¼š
                [
                   { "scene": "1", "shot": "1", "camera": "å…¨æ™¯ (LS)", "visual": "å…‰æ˜é¡¶å¤§æ®¿ä¸€ç‰‡ç‹¼è—‰ï¼Œçº¢æ¯¯å‡Œä¹±ã€‚å‘¨èŠ·è‹¥ç‹¬è‡ªç«™åœ¨ä¸­å¤®ã€‚", "assets": "åœºæ™¯:å¤§æ®¿", "mj_base": "messy bright top hall, red carpet, Zhou Zhiruo standing alone" },
                   { "scene": "1", "shot": "2", "camera": "ä¸­æ™¯ (MS)", "visual": "å‘¨èŠ·è‹¥ç¼“ç¼“æŠ¬èµ·åŒæ‰‹ï¼Œæ‘˜ä¸‹å¤´ä¸Šæ²‰é‡çš„å‡¤å† ã€‚", "assets": "è§’è‰²:å‘¨èŠ·è‹¥", "mj_base": "Zhou Zhiruo taking off her heavy phoenix crown" },
                   { "scene": "1", "shot": "3", "camera": "ç‰¹å†™ (CU)", "visual": "å‡¤å† é‡é‡åœ°ç ¸åœ¨æœ¨åœ°æ¿ä¸Šï¼Œç ç¿ æ•£è½ã€‚", "assets": "é“å…·:å‡¤å† ", "mj_base": "phoenix crown smashing on wooden floor, beads scattering" },
                   { "scene": "1", "shot": "4", "camera": "å¤§ç‰¹å†™ (ECU)", "visual": "å‘¨èŠ·è‹¥çš„è„¸éƒ¨ç‰¹å†™ã€‚å¥¹çœ¼ç¥ä¸­çš„ç‹ å‰æ¶ˆæ•£ï¼ŒåŒ–ä¸ºå‡„ç¾ã€‚", "assets": "è§’è‰²:å‘¨èŠ·è‹¥", "mj_base": "Extreme close up of Zhou Zhiruo's face, sorrowful eyes, beautiful expression" }
                ]

                ã€ä»»åŠ¡ã€‘ï¼š
                è¯·å°†ç”¨æˆ·è¾“å…¥çš„å‰§æœ¬ï¼ŒæŒ‰ä¸Šè¿°é€»è¾‘æ‹†è§£ã€‚
                mj_base å­—æ®µåªå†™ç”»é¢å†…å®¹çš„è‹±æ–‡ï¼Œ**ä¸è¦**å†™ç”»é£åç¼€ï¼ˆåç¼€ç”±å‰ç«¯æ‹¼æ¥ï¼‰ã€‚

                è¯·è¿”å› JSON æ•°ç»„ã€‚
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt + "\n\nç”¨æˆ·å‰§æœ¬:\n" + script }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 8000 },
                        // é˜²æ­¢æ–­è¿çš„å®‰å…¨è®¾ç½®
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errText}`);
                }

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                if (!data.candidates || !data.candidates[0].content) throw new Error("No content returned");

                let jsonText = data.candidates[0].content.parts[0].text;
                jsonText = jsonText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                if (!jsonText.endsWith(']')) {
                    const idx = jsonText.lastIndexOf('}');
                    if (idx !== -1) jsonText = jsonText.substring(0, idx+1) + ']';
                }

                const shots = JSON.parse(jsonText);
                // ä¼ å…¥ç”¨æˆ·å¡«å†™çš„åç¼€è¿›è¡Œæ¸²æŸ“
                renderTable(shots, styleSuffix);

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#ff5252; padding:40px;">âŒ å¤±è´¥ï¼š${e.message}</td></tr>`;
            } finally {
                btn.disabled = false;
                icon.style.display = "none";
                txt.innerText = "ğŸš€ è’™å¤ªå¥‡æ‹†è§£ & ç”Ÿæˆ";
            }
        }

        function renderTable(data, suffix) {
            const tbody = document.getElementById('tableBody');
            let html = '';
            data.forEach(r => {
                // ğŸ”¥ å¼ºåŠ›æ‹¼æ¥ï¼šBase + Suffix ğŸ”¥
                const fullPrompt = `${r.mj_base}, <span class="style-suffix">${suffix}</span>`;

                html += `<tr>
                    <td style="font-family:monospace; font-weight:bold; color:#666">${r.scene}-${r.shot}</td>
                    <td class="camera-col">${r.camera}</td>
                    <td class="asset-col">${r.assets || '-'}</td>
                    <td style="font-size:13px; color:#ddd;">${r.visual}</td>
                    <td>
                        <div class="prompt-box">
                            ${fullPrompt}
                            <span class="copy-btn" onclick="navigator.clipboard.writeText(this.parentElement.innerText.replace('COPY','').trim());alert('å·²å¤åˆ¶!')">COPY</span>
                        </div>
                    </td>
                    <td style="font-weight:bold">${r.duration || '2s'}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function exportToCSV() {
            const rows = Array.from(document.querySelectorAll('#tableBody tr'));
            if(rows.length === 0 || rows[0].innerText.includes("ç­‰å¾…è¾“å…¥")) return alert("æ— æ•°æ®");
            
            let csv = "\uFEFF#\té•œå¤´\tèµ„äº§\tç”»é¢\tæç¤ºè¯\tæ—¶é•¿\n";
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length > 1) {
                    const line = Array.from(cols).map(c => `"${c.innerText.replace(/"/g, '""').replace(/COPY/g, '').trim()}"`).join('\t');
                    csv += line + "\n";
                }
            });
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
            link.download = "Director_Montage_List.csv";
            link.click();
        }
    </script>
</body>
</html>